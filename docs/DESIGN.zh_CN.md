# 设计说明

此程序旨在帮助**目标程序**在 Windows 平台完成“文件格式关联相关信息的注册”与“文件格式关联的管理”操作。

## 词汇定义

- 目标程序：此程序所帮助管理文件格式关联信息的程序。尽管类型不限但通常是便携程序。
- 配置文件：用于描述目标程序的文件格式关联的相关信息的文件，文件扩展名为 `.pacfg`，文件格式类型为 `ini`。
- 文件格式：指目标程序所支持的文件类型，概念上近似文件扩展名，但一个文件格式可能对应多个近似的扩展名（例如 `.jpg`、`.jpeg` 和 `.jfif` 都是 JPEG 文件格式的文件）。
- `ProgID`：程序标识符（Programmatic Identifier），但此应用中基本等同于描述一组文件格式。选用此名称是因为和注册表对应的字段名称一致。

## 目标场景

### 面向开发者：随自己的程序分发本程序作为文件格式关联管理的辅助工具

此场景中，开发者自己所开发的程序即此处的“目标程序”，此程序随附其中，并附带对应的配置文件。用户启动此程序时，通过预先配置直接自动载入预期的配置文件，用户可直接按界面提示进行格式关联操作。用户完全不需要自己编写任何 `.pacfg` 配置，只需要双击随附的本程序可执行文件即可。

作为近似场景，此程序亦可被安装器或类似性质的程序调用（但暂无静默关联选项）。

### 面向用户：帮助自己管理不同程序的文件格式关联信息

此场景中，用户自己需要自己编写适用于不同程序的 `.pacfg` 配置，以供后续使用。

用户可独立启动本程序，本程序提供了对自身关联 `.pacfg` 配置的功能，完成自身关联后，用户即可通过编写 `.pacfg` 来声明其它程序的关联配置，并通过双击 `.pacfg` 文件的形式对对应配置所描述的目标程序的文件格式关联进行管理。

## 程序行为

程序无参数启动时，会尝试查找配置文件，默认会查找当前目录下的 `default-assoc.pacfg` 文件，若未找到则会检查程序内附资源是否包含 `qrc:/default-assoc.pacfg`，若仍未找到则会报错退出。程序也接受 `-c`/`--config` 参数允许通过命令行指定配置文件。

定位到配置文件后，根据配置文件中的信息对用户呈现目标程序所支持的文件格式列表（一系列 `ProgId`）。用户可在对应列表中勾选自己希望目标程序所支持的文件格式。

当用户点击“注册关联”按钮时，程序会先向系统注册目标程序的基本信息（显示名称等），然后根据用户所勾选的文件格式列表，注册或取消注册目标程序所支持的文件格式。如果点击“注册关联”按钮时没有勾选任何文件格式，则会向系统取消注册目标程序以及所有文件格式关联信息。

## 相关注册表位置

假定目标程序 `MyApp.exe`，期望支持的文件格式是 JPEG，包含扩展名 `jpg`，本程序会向下列注册表位置写入内容：

```ini
; ----------------------------------------------------------
; 1. 声明 MyApp 的 Capabilities（核心）
; ----------------------------------------------------------
[HKEY_CURRENT_USER\Software\Classes\Applications\MyApp.exe\Capabilities]
"ApplicationName"="MyApp"
"ApplicationDescription"="MyApp Image Viewer"

[HKEY_CURRENT_USER\Software\Classes\Applications\MyApp.exe\Capabilities\FileAssociations]
".jpg"="MyApp.jpg"

; ----------------------------------------------------------
; 2. 将 MyApp 注册进 RegisteredApplications（必须）
;    这样 ms-settings:defaultapps?registeredAppUser=MyApp 才能找到
; ----------------------------------------------------------
[HKEY_CURRENT_USER\Software\RegisteredApplications]
"MyApp"="Software\\Classes\\Applications\\MyApp.exe\\Capabilities"

; ----------------------------------------------------------
; 3. 定义 ProgID: MyApp.jpg
; ----------------------------------------------------------
[HKEY_CURRENT_USER\Software\Classes\MyApp.jpg]
@="MyApp JPEG File"

[HKEY_CURRENT_USER\Software\Classes\MyApp.jpg\DefaultIcon]
@="\"C:\\path\\to\\MyApp.exe\",0"

[HKEY_CURRENT_USER\Software\Classes\MyApp.jpg\shell\open\command]
@="\"C:\\path\\to\\MyApp.exe\" \"%1\""

; ----------------------------------------------------------
; 4. 让系统知道 MyApp 支持这些扩展名（打开方式菜单）
; ----------------------------------------------------------
[HKEY_CURRENT_USER\Software\Classes\.jpg\OpenWithProgids]
"MyApp.jpg"=hex(0):
```

## 分发说明

此程序基于 Qt 6，对于同样基于 Qt 6 且动态链接 Qt 依赖的程序（例如使用官方版 Qt 进行分发的程序），最佳分发方式即使用版本相同的 Qt 构建此程序，并将构建产物随目标程序一同分发，使此程序可复用目标程序的运行时，确保此程序的体积最小。这是预期的分发方式。

此程序无 Qt 外的依赖，所以亦可比较轻松的静态编译，但静态编译版本可能（相对于普通 Win32 程序）体积较大，故仅适用于对文件大小不敏感的场景。

请注意：此程序使用 MIT 协议。此程序本体为减小体积而没有直接附带 MIT 协议文本，你需要自行确保分发符合本程序的 MIT 协议的条款。
