name: Windows CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      qt_ver:
        description: 'Qt Version to use'
        required: false
        default: '6.10.2'
      tag_ver:
        description: 'Git tag or ref to checkout (leave empty for latest code)'
        required: false
        default: ''

jobs:
  msvc-cmake-build:
    runs-on: windows-2022

    env:
      QT_VER: ${{ inputs.qt_ver || '6.10.2' }}
      VS_VER: '2022'
      AQT_ARCH: 'win64_msvc2022_64'
      MSVC_ARCH: 'x64'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.tag_ver }}
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        arch: ${{ env.AQT_ARCH }}
        version: ${{ env.QT_VER }}
        cache: true
    - name: Build
      shell: cmd
      run: |
        :: ------ env ------
        set PWD=%cd%
        set VS=${{ env.VS_VER }}
        set VCVARS="C:\Program Files\Microsoft Visual Studio\%VS%\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        if not exist %VCVARS% set VCVARS="C:\Program Files (x86)\Microsoft Visual Studio\%VS%\Enterprise\VC\Auxiliary\Build\vcvarsall.bat"
        call %VCVARS% ${{ env.MSVC_ARCH }}
        :: ------ app ------
        echo ::group::===== App (Build'n'Install) =====
        cmake -Bbuild .
        cmake --build build --config Release
        cmake --install build --config Release --prefix "%PWD%\build"
        echo ::endgroup::
        :: ------ pkg ------
        windeployqt --verbose=2 --no-compiler-runtime --no-quick-import --no-translations --no-opengl-sw --no-system-d3d-compiler --no-system-dxc-compiler --no-network --skip-plugin-types tls,networkinformation build\bin\passoc.exe
        copy LICENSE build\bin
        exit /B 0
    - uses: actions/upload-artifact@v4
      with:
        name: "windows-msvc${{ env.VS_VER }}-qt${{ env.QT_VER }}${{ inputs.tag_ver && format('-{0}', inputs.tag_ver) || '' }}-passoc-package"
        path: build/bin/*
